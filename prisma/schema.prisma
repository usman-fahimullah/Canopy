// prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

// =================================================================
// ACCOUNT — Shared identity for every authenticated person.
// Maps 1:1 to a Supabase Auth user. A person can be an employer member,
// a job seeker, a coach, or multiple of these simultaneously.
// =================================================================

model Account {
  id         String  @id @default(cuid())
  supabaseId String  @unique
  email      String  @unique
  name       String?
  avatar     String?
  phone      String?
  location   String?
  timezone   String?
  bio        String? @db.Text

  // Activity tracking
  lastActiveAt DateTime? // Updated by API routes (debounced, max once per 5 min)

  // Onboarding fields (shared across roles)
  pronouns  String? // e.g., "he/him", "she/her", "they/them"
  ethnicity String? // For diversity reporting
  birthday  DateTime?

  // Social URLs
  linkedinUrl  String? // LinkedIn profile URL
  instagramUrl String?
  threadsUrl   String?
  facebookUrl  String?
  blueskyUrl   String?
  xUrl         String?
  websiteUrl   String?

  // Multi-role onboarding
  entryIntent        String? // "talent" | "coach" | "employer" — what brought them here
  activeRoles        String[] // Accumulated roles: ["talent", "coach", "employer"]
  primaryRole        String? // Determines default shell on login
  onboardingProgress Json? // Per-role completion tracking (OnboardingProgress type)

  // Role profiles (a person can hold multiple)
  orgMemberships OrganizationMember[]
  seekerProfile  SeekerProfile?
  coachProfile   CoachProfile?

  // Messaging
  conversationParticipants ConversationParticipant[]
  sentMessages             Message[]                 @relation("MessageSender")

  // Notifications
  notifications          Notification[]
  notificationPreference NotificationPreference?

  // Team invites sent by this account
  invitesSent TeamInvite[] @relation("InvitedByAccount")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =================================================================
// ORGANIZATION — Multi-tenant employer container.
// =================================================================

model Organization {
  id   String  @id @default(cuid())
  name String
  slug String  @unique
  logo String?

  // Onboarding fields
  description String?  @db.Text // Company description
  website     String? // Company website URL
  location    String? // Company headquarters location
  size        String? // "1-10" | "11-50" | "51-200" | "201-1000" | "1000+"
  industries  String[] // PathwayType slugs: ["energy", "agriculture"]
  hiringGoal  String? // "specific-role" | "multiple-roles" | "exploring"

  // Brand kit for career pages
  primaryColor   String  @default("#0F766E")
  secondaryColor String?
  fontFamily     String  @default("Inter")

  // Career page settings
  customDomain      String? @unique
  careerPageJson    String? @db.Text
  careerPageSlug    String? @unique
  careerPageConfig  Json? // Structured career page config (sections + theme)
  careerPageEnabled Boolean @default(false)

  // Diversity badges (NEW for Job Seeker Portal)
  isBipocOwned   Boolean @default(false)
  isWomenOwned   Boolean @default(false)
  isVeteranOwned Boolean @default(false)

  // Onboarding status
  onboardingCompleted Boolean @default(false)

  // Primary pathway/industry focus
  primaryPathwayId String?
  primaryPathway   Pathway? @relation("OrganizationPrimaryPathway", fields: [primaryPathwayId], references: [id])

  members OrganizationMember[]
  jobs    Job[]

  // Sponsor collections (NEW for Job Seeker Portal)
  sponsoredCollections Collection[]

  // Team invites
  teamInvites TeamInvite[]

  // Job templates (Canopy ATS)
  jobTemplates JobTemplate[]

  // Offer letter configuration
  offerTemplate        String?        @db.Text // JSON: default offer letter template
  defaultSigningMethod SigningMethod? // Org's preferred signing method

  // Offer records
  offers OfferRecord[]

  // Email templates
  emailTemplates EmailTemplate[]

  // Approval requests
  approvalRequests ApprovalRequest[]

  // External integrations (Nango)
  integrationConnections IntegrationConnection[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =================================================================
// ORGANIZATION MEMBER — Employer-side role within an org.
// Replaces the old User model. One Account can belong to multiple
// Organizations. Adds RECRUITER to the role enum.
// =================================================================

model OrganizationMember {
  id String @id @default(cuid())

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  role  OrgMemberRole @default(MEMBER)
  title String?

  // Authored content
  notes  Note[]
  scores Score[]

  // Interview & approval relations
  interviews          Interview[]
  approvalRequests    ApprovalRequest[] @relation("ApprovalRequester")
  approvalAssignments ApprovalRequest[] @relation("ApprovalApprover")

  // Job assignments (Phase B: scoped access)
  recruitedJobs  Job[]             @relation("JobRecruiter")
  managedJobs    Job[]             @relation("JobHiringManager")
  jobAssignments JobAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([accountId, organizationId])
  @@index([accountId])
  @@index([organizationId])
}

enum OrgMemberRole {
  ADMIN
  RECRUITER
  HIRING_MANAGER
  MEMBER
  VIEWER
}

// =================================================================
// TEAM INVITE — Pending invitations to join an organization.
// Created during employer onboarding or from the team settings page.
// =================================================================

model TeamInvite {
  id String @id @default(cuid())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  invitedById String
  invitedBy   Account @relation("InvitedByAccount", fields: [invitedById], references: [id])

  email          String
  role           OrgMemberRole @default(RECRUITER)
  assignedJobIds String[]
  token          String        @unique
  expiresAt      DateTime
  status         InviteStatus  @default(PENDING)
  acceptedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([email])
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// =================================================================
// SEEKER PROFILE — Job seeker identity. Independent of any org.
// Replaces the old Candidate model. A seeker can apply across
// multiple organizations.
// =================================================================

model SeekerProfile {
  id String @id @default(cuid())

  accountId String  @unique
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // Profile display (NEW for Job Seeker Portal)
  coverImage String?
  badge      String? // e.g., "Just Graduated", "Climate Leader"
  summary    String? @db.Text

  // Onboarding - Career Journey
  careerStage CareerStage? // Entry level, mid-career, career changer, etc.
  motivations String[] // ["finding-job", "exploring-options", "learning-skills", etc.]

  // Onboarding - Pathway interests (many-to-many)
  interestedPathways SeekerPathway[]

  // Professional info
  resumeUrl      String?
  coverLetterUrl String?
  portfolioUrl   String?
  headline       String?

  // Skills & qualifications
  skills          String[]
  greenSkills     String[]
  certifications  String[]
  yearsExperience Int?

  // AI-enriched data
  aiSummary String? @db.Text

  // Mentorship (peer-to-peer, pro-bono)
  isMentor          Boolean  @default(false)
  mentorBio         String?  @db.Text
  mentorTopics      String[]
  mentorSpecialty   String? // Primary expertise area (e.g., "Clean Product Development")
  mentorBadge       String? // "top_mentor" | "quick_responder" | "featured"
  mentorRating      Float?   @default(0)
  mentorReviewCount Int      @default(0)

  // Sector interests (for matching)
  targetSectors String[]

  // Relations
  applications Application[]
  notes        Note[]

  // Mentorship relations
  mentorAssignmentsAsMentor MentorAssignment[] @relation("MentorSide")
  mentorAssignmentsAsMentee MentorAssignment[] @relation("MenteeSide")
  mentorReviewsGiven        MentorReview[]     @relation("MentorReviewsByMentee")
  mentorReviewsReceived     MentorReview[]     @relation("MentorReviewsReceived")
  coachAssignmentsAsSeeker  CoachAssignment[]

  // Coaching session relations
  sessions    Session[]
  bookings    Booking[]
  reviews     Review[]
  actionItems ActionItem[]

  // Job Seeker Portal relations (NEW)
  goals            Goal[]
  savedJobs        SavedJob[]
  workExperiences  WorkExperience[]
  authoredJobNotes JobNote[]        @relation("JobNoteAuthor")
  savedJobNotes    JobNoteSave[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isMentor])
}

// =================================================================
// COACH PROFILE — Professional career coach. Paid relationship.
// =================================================================

model CoachProfile {
  id String @id @default(cuid())

  accountId String  @unique
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // Profile info (denormalized for easy access)
  firstName String?
  lastName  String?
  photoUrl  String?
  bio       String? @db.Text

  // Professional info
  headline       String?
  expertise      String[]
  sectors        String[]
  sessionTypes   String[]
  yearsInClimate Int?

  // Pricing (in cents for precision)
  sessionRate     Int  @default(15000) // Default $150
  sessionDuration Int  @default(60) // minutes
  hourlyRate      Int?
  monthlyRate     Int?

  // Availability (JSON: WeeklyAvailability)
  availability       String? @db.Text
  bufferTime         Int     @default(15) // minutes between sessions
  maxSessionsPerWeek Int?
  videoLink          String?

  // Stripe Connect
  stripeAccountId String?

  // Stats
  rating         Float? @default(0)
  reviewCount    Int    @default(0)
  totalSessions  Int    @default(0)
  totalEarnings  Int    @default(0) // in cents
  successStories Int    @default(0)

  // Status
  status          CoachStatus @default(PENDING)
  applicationDate DateTime?
  approvalDate    DateTime?
  isActive        Boolean     @default(true)
  isFeatured      Boolean     @default(false)

  // Relations
  coachAssignments CoachAssignment[]
  sessions         Session[]
  bookings         Booking[]
  reviews          Review[]
  actionItems      ActionItem[]
  notes            Note[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([isActive])
  @@index([isActive, isFeatured])
}

enum CoachStatus {
  PENDING
  APPROVED
  REJECTED
  ACTIVE
  PAUSED
}

// =================================================================
// MENTOR ASSIGNMENT — Peer-to-peer seeker-to-seeker mentorship.
// Mentor = a seeker with isMentor: true who volunteers time.
// Pro-bono, distinct from paid coaching.
// =================================================================

model MentorAssignment {
  id String @id @default(cuid())

  mentorId String
  mentor   SeekerProfile @relation("MentorSide", fields: [mentorId], references: [id], onDelete: Cascade)

  menteeId String
  mentee   SeekerProfile @relation("MenteeSide", fields: [menteeId], references: [id], onDelete: Cascade)

  status    MentorshipStatus @default(ACTIVE)
  startedAt DateTime         @default(now())
  endedAt   DateTime?
  notes     String?          @db.Text

  reviews MentorReview[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([mentorId, menteeId])
}

enum MentorshipStatus {
  PENDING
  ACTIVE
  PAUSED
  COMPLETED
}

// =================================================================
// MENTOR REVIEW — Post-mentorship feedback from mentee.
// =================================================================

model MentorReview {
  id String @id @default(cuid())

  assignmentId String
  assignment   MentorAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  menteeId String
  mentee   SeekerProfile @relation("MentorReviewsByMentee", fields: [menteeId], references: [id], onDelete: Cascade)

  mentorId String
  mentor   SeekerProfile @relation("MentorReviewsReceived", fields: [mentorId], references: [id], onDelete: Cascade)

  rating  Int // 1-5
  comment String? @db.Text

  createdAt DateTime @default(now())

  @@unique([assignmentId, menteeId])
}

// =================================================================
// COACH ASSIGNMENT — Professional coach-to-seeker relationship.
// =================================================================

model CoachAssignment {
  id String @id @default(cuid())

  coachId String
  coach   CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)

  seekerId String
  seeker   SeekerProfile @relation(fields: [seekerId], references: [id], onDelete: Cascade)

  status    CoachingStatus @default(ACTIVE)
  startedAt DateTime       @default(now())
  endedAt   DateTime?

  sessionsCompleted Int     @default(0)
  plan              String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([coachId, seekerId])
}

enum CoachingStatus {
  PENDING
  ACTIVE
  PAUSED
  COMPLETED
}

// =================================================================
// SESSION — Scheduled coaching call between coach and mentee.
// =================================================================

model Session {
  id    String  @id @default(cuid())
  title String? // e.g., "1:1 Overview Session", "Resume Review"

  coachId String
  coach   CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)

  menteeId String
  mentee   SeekerProfile @relation(fields: [menteeId], references: [id], onDelete: Cascade)

  scheduledAt DateTime
  duration    Int           @default(60) // minutes
  status      SessionStatus @default(SCHEDULED)

  videoLink     String?
  menteeMessage String? @db.Text
  coachNotes    String? @db.Text
  sessionNumber Int? // e.g., "Session 3 of 8"

  cancellationReason String?
  cancelledBy        String? // "mentee" or "coach"
  cancelledAt        DateTime?
  completedAt        DateTime?

  // Relations
  booking     Booking?
  review      Review?
  actionItems ActionItem[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([coachId])
  @@index([menteeId])
  @@index([status])
  @@index([scheduledAt])
  @@index([coachId, scheduledAt])
  @@index([menteeId, status])
  @@index([menteeId, scheduledAt])
  @@index([deletedAt])
}

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// =================================================================
// BOOKING — Payment record for a session.
// =================================================================

model Booking {
  id String @id @default(cuid())

  sessionId String  @unique
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  menteeId String
  mentee   SeekerProfile @relation(fields: [menteeId], references: [id], onDelete: Cascade)

  coachId String
  coach   CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)

  // Amounts in cents
  amount      Int // Total charged
  platformFee Int // Platform's cut (18%)
  coachPayout Int // What coach receives
  currency    String @default("usd")

  // Stripe references
  stripeCheckoutSessionId String? @unique
  stripePaymentIntentId   String? @unique
  stripeTransferId        String?

  status       BookingStatus @default(PENDING)
  refundAmount Int?
  refundReason String?

  paidAt     DateTime?
  refundedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([menteeId])
  @@index([menteeId, status])
  @@index([status])
  @@index([coachId, createdAt])
  @@index([status, createdAt])
}

enum BookingStatus {
  PENDING
  PAID
  REFUNDED
  PARTIALLY_REFUNDED
  FAILED
}

// =================================================================
// REVIEW — Post-session feedback from mentee.
// =================================================================

model Review {
  id String @id @default(cuid())

  sessionId String  @unique
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  menteeId String
  mentee   SeekerProfile @relation(fields: [menteeId], references: [id], onDelete: Cascade)

  coachId String
  coach   CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)

  rating        Int // 1-5
  comment       String? @db.Text
  coachResponse String? @db.Text

  isVisible  Boolean @default(true)
  isFlagged  Boolean @default(false)
  flagReason String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([coachId])
  @@index([coachId, isVisible])
  @@index([menteeId])
  @@index([createdAt])
  @@index([deletedAt])
}

// =================================================================
// ACTION ITEM — Tasks assigned after a session.
// =================================================================

model ActionItem {
  id String @id @default(cuid())

  sessionId String
  session   Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  menteeId String
  mentee   SeekerProfile @relation(fields: [menteeId], references: [id], onDelete: Cascade)

  coachId String
  coach   CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)

  description String
  dueDate     DateTime?
  status      ActionItemStatus @default(PENDING)
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([menteeId, status])
  @@index([sessionId])
}

enum ActionItemStatus {
  PENDING
  COMPLETED
}

// =================================================================
// CONVERSATION — Chat thread container for messaging.
// =================================================================

model Conversation {
  id            String    @id @default(cuid())
  lastMessageAt DateTime?

  participants ConversationParticipant[]
  messages     Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =================================================================
// CONVERSATION PARTICIPANT — Join table (Conversation <-> Account).
// =================================================================

model ConversationParticipant {
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  joinedAt   DateTime  @default(now())
  lastReadAt DateTime?

  @@id([conversationId, accountId])
}

// =================================================================
// MESSAGE — Individual chat message within a conversation.
// =================================================================

model Message {
  id String @id @default(cuid())

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderId String
  sender   Account @relation("MessageSender", fields: [senderId], references: [id])

  content        String   @db.Text
  attachmentUrls String[]

  createdAt DateTime @default(now())

  @@index([conversationId, createdAt])
  @@index([senderId])
}

// =================================================================
// NOTIFICATION — In-app + email notifications.
// =================================================================

model Notification {
  id String @id @default(cuid())

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  type  NotificationType
  title String
  body  String
  data  String?          @db.Text // JSON for action URL, entity IDs, etc.

  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([accountId, readAt])
  @@index([accountId, createdAt])
}

enum NotificationType {
  SESSION_BOOKED
  SESSION_REMINDER
  SESSION_CANCELLED
  SESSION_COMPLETED
  REVIEW_REQUEST
  NEW_MESSAGE
  COACH_APPROVED
  COACH_REJECTED
  PAYMENT_RECEIVED
  MENTOR_REQUEST
  GOAL_DUE_SOON // Goal due in 3 days
  GOAL_INACTIVE // Goal hasn't been updated in 5 days
  NEW_APPLICATION // New application received on a job
  OFFER_RECEIVED // Candidate received an offer letter
  OFFER_VIEWED // Employer notified: candidate viewed the offer
  APPLICATION_RECEIVED // Candidate notified: their application was received
  STAGE_CHANGED // Candidate notified: moved to a new hiring stage
  INTERVIEW_SCHEDULED // Candidate notified: interview has been scheduled
  APPLICATION_REJECTED // Candidate notified: application was rejected
  APPROVAL_PENDING // Approver notified: action needs approval
  APPROVAL_APPROVED // Requester notified: action was approved
  APPROVAL_REJECTED // Requester notified: action was rejected
}

// =================================================================
// NOTIFICATION PREFERENCES — Per-account notification settings.
// =================================================================

model NotificationPreference {
  id String @id @default(cuid())

  accountId String  @unique
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // Per-type toggles stored as JSON for flexibility
  // e.g. { "SESSION_BOOKED": true, "NEW_MESSAGE": false }
  inAppPrefs Json @default("{}")
  emailPrefs Json @default("{}")

  // Global email frequency: "immediate" | "daily" | "weekly" | "never"
  emailFrequency String @default("immediate")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =================================================================
// JOB — Extended for Job Seeker Portal features.
// =================================================================

model Job {
  id             String         @id @default(cuid())
  title          String
  slug           String
  description    String         @db.Text
  descriptionHtml String?       @db.Text
  location       String?
  locationType   LocationType   @default(ONSITE)
  employmentType EmploymentType @default(FULL_TIME)
  salaryMin      Int?
  salaryMax      Int?
  salaryCurrency String         @default("USD")
  salaryPeriod   SalaryPeriod?

  // Climate-specific fields
  climateCategory   String?
  impactDescription String?  @db.Text
  requiredCerts     String[]
  greenSkills       String[]

  // Job Seeker Portal fields (NEW)
  pathwayId       String?
  pathway         Pathway?         @relation(fields: [pathwayId], references: [id])
  experienceLevel ExperienceLevel?
  educationLevel  EducationLevel?
  isFeatured      Boolean          @default(false)

  status      JobStatus @default(DRAFT)
  publishedAt DateTime?
  closesAt    DateTime?

  stages String @default("[{\"id\":\"applied\",\"name\":\"Applied\"},{\"id\":\"screening\",\"name\":\"Screening\"},{\"id\":\"qualified\",\"name\":\"Qualified\"},{\"id\":\"interview\",\"name\":\"Interview\"},{\"id\":\"offer\",\"name\":\"Offer\"},{\"id\":\"hired\",\"name\":\"Hired\"}]")

  // Application form configuration
  formConfig    Json? // { personalDetails: {...}, careerDetails: {...}, requiredFiles: {...} }
  formQuestions Json? // Array of custom question objects

  // Email automation config per pipeline stage
  emailAutomation String? @db.Text // JSON: { [stageId]: { enabled: boolean, templateId: string } }

  // External syndication
  syndicationEnabled Boolean @default(false)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Team assignment — who's responsible for this role
  recruiterId     String?
  recruiter       OrganizationMember? @relation("JobRecruiter", fields: [recruiterId], references: [id], onDelete: SetNull)
  hiringManagerId String?
  hiringManager   OrganizationMember? @relation("JobHiringManager", fields: [hiringManagerId], references: [id], onDelete: SetNull)

  // Reviewer assignments (many-to-many via junction table)
  reviewerAssignments JobAssignment[]

  applications    Application[]
  syndicationLogs SyndicationLog[]

  // Job Seeker Portal relations (NEW)
  savedBy     SavedJob[]
  collections CollectionJob[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([status])
  @@index([pathwayId])
  @@index([publishedAt])
  @@index([recruiterId])
  @@index([hiringManagerId])
}

// =================================================================
// JOB ASSIGNMENT — Assigns team members (reviewers) to specific jobs.
// Hiring Manager and Recruiter use 1:1 FK on Job; this table handles
// many-to-many reviewer assignments for scoped access control.
// =================================================================

model JobAssignment {
  id String @id @default(cuid())

  jobId String
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  memberId String
  member   OrganizationMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@unique([jobId, memberId])
  @@index([memberId])
  @@index([jobId])
}

// =================================================================
// JOB TEMPLATE — Reusable template created from an existing role.
// Stores a subset of job fields (toggled on by the employer) as JSON.
// =================================================================

model JobTemplate {
  id             String       @id @default(cuid())
  name           String
  sourceJobId    String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  fieldData      String       @db.Text // JSON: { title: "...", climateCategory: "...", ... }
  activeFields   String       @db.Text // JSON: ["title", "climateCategory", ...]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
}

enum ExperienceLevel {
  ENTRY
  INTERMEDIATE
  SENIOR
  EXECUTIVE
}

enum JobStatus {
  DRAFT
  PUBLISHED
  PAUSED
  CLOSED
}

enum LocationType {
  ONSITE
  REMOTE
  HYBRID
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
  VOLUNTEER
}

enum SalaryPeriod {
  ANNUAL
  HOURLY
  WEEKLY
  MONTHLY
}

enum EducationLevel {
  NONE
  HIGH_SCHOOL
  ASSOCIATE
  BACHELOR
  MASTER
  DOCTORATE
  VOCATIONAL
  PROFESSIONAL
}

// =================================================================
// APPLICATION — Links SeekerProfile to Job.
// =================================================================

model Application {
  id String @id @default(cuid())

  seekerId String
  seeker   SeekerProfile @relation(fields: [seekerId], references: [id], onDelete: Cascade)

  jobId String
  job   Job    @relation(fields: [jobId], references: [id])

  stage      String @default("applied")
  stageOrder Int    @default(0)

  formResponses String? @db.Text
  coverLetter   String? @db.Text

  matchScore   Float?
  matchReasons String? @db.Text

  knockoutPassed Boolean @default(true)

  source String?

  scores Score[]
  goals  Goal[] // Related goals for this application

  // Offer tracking
  offer     OfferRecord?
  offeredAt DateTime?

  // Interview tracking
  interviews Interview[]

  rejectedAt DateTime?
  hiredAt    DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([seekerId, jobId])
  @@index([seekerId])
  @@index([jobId])
  @@index([stage])
  @@index([createdAt])
  @@index([jobId, stage])
  @@index([jobId, createdAt])
  @@index([deletedAt])
}

// =================================================================
// NOTE — Polymorphic author: OrgMember or Coach.
// Subject is always a SeekerProfile.
// =================================================================

model Note {
  id      String @id @default(cuid())
  content String @db.Text

  // Subject: which seeker is this note about
  seekerId String
  seeker   SeekerProfile @relation(fields: [seekerId], references: [id], onDelete: Cascade)

  // Author: exactly one of these should be set (enforced at app level)
  orgMemberAuthorId String?
  orgMemberAuthor   OrganizationMember? @relation(fields: [orgMemberAuthorId], references: [id], onDelete: SetNull)

  coachAuthorId String?
  coachAuthor   CoachProfile? @relation(fields: [coachAuthorId], references: [id], onDelete: SetNull)

  // For @mentions (Account IDs)
  mentions String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([seekerId])
  @@index([seekerId, createdAt])
}

// =================================================================
// SCORE — Only org members score applications.
// =================================================================

model Score {
  id String @id @default(cuid())

  applicationId String
  application   Application @relation(fields: [applicationId], references: [id])

  scorerId String
  scorer   OrganizationMember @relation(fields: [scorerId], references: [id])

  responses      String         @db.Text
  overallRating  Int
  recommendation Recommendation
  comments       String?        @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([applicationId, scorerId])
}

enum Recommendation {
  STRONG_YES
  YES
  NEUTRAL
  NO
  STRONG_NO
}

// =================================================================
// JOB SEEKER PORTAL — New models for job discovery and career tracking
// =================================================================

// =================================================================
// PATHWAY — Career pathway categories (Agriculture, Conservation, etc.)
// =================================================================

model Pathway {
  id           String  @id @default(cuid())
  name         String
  slug         String  @unique
  description  String? @db.Text
  icon         String? // Phosphor icon name (e.g., "Leaf", "Tree", "Lightning")
  illustration String? // Path to spot illustration SVG (e.g., "/illustrations/pathways/energy.svg")
  color        String? // Color family: green, blue, orange, red, yellow, purple
  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  // Relations
  jobs                 Job[]
  interestedSeekers    SeekerPathway[]
  organizationsPrimary Organization[]  @relation("OrganizationPrimaryPathway")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =================================================================
// COLLECTION — Curated job collections (e.g., "Urban Dwellers")
// =================================================================

model Collection {
  id              String  @id @default(cuid())
  title           String
  slug            String  @unique
  description     String? @db.Text
  backgroundImage String?
  gradientColors  String? // JSON array of hex colors, e.g., ["#10B981", "#3B82F6"]

  // Sponsor (optional)
  sponsorId String?
  sponsor   Organization? @relation(fields: [sponsorId], references: [id])

  isFeatured   Boolean @default(false)
  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  // Filter criteria for dynamic collections (JSON)
  filterCriteria String? @db.Text

  jobs CollectionJob[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Join table for Collection <-> Job (many-to-many)
model CollectionJob {
  collectionId String
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  jobId String
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  displayOrder Int      @default(0)
  addedAt      DateTime @default(now())

  @@id([collectionId, jobId])
}

// =================================================================
// GOAL — Career goal tracking with milestones
// =================================================================

model Goal {
  id String @id @default(cuid())

  seekerId String
  seeker   SeekerProfile @relation(fields: [seekerId], references: [id], onDelete: Cascade)

  // Optional link to a job application
  applicationId String?
  application   Application? @relation(fields: [applicationId], references: [id], onDelete: SetNull)

  title       String
  description String?       @db.Text
  notes       String?       @db.Text // Journal/reflection notes
  icon        String? // Phosphor icon name
  category    GoalCategory?

  progress    Int        @default(0) // 0-100
  targetDate  DateTime?
  completedAt DateTime?
  status      GoalStatus @default(ACTIVE)

  milestones Milestone[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([applicationId])
  @@index([seekerId])
  @@index([seekerId, status])
  @@index([targetDate])
}

model Milestone {
  id String @id @default(cuid())

  goalId String
  goal   Goal   @relation(fields: [goalId], references: [id], onDelete: Cascade)

  title       String
  completed   Boolean   @default(false)
  completedAt DateTime?
  order       Int       @default(0)
  resources   String?   @db.Text // JSON array of {title: string, url: string} (max 3 resources)

  createdAt DateTime @default(now())
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum GoalCategory {
  INTERVIEWING
  NETWORKING
  COMPENSATION
  ORGANIZATION
}

// =================================================================
// SAVED JOB — Jobs bookmarked by seekers
// =================================================================

model SavedJob {
  seekerId String
  seeker   SeekerProfile @relation(fields: [seekerId], references: [id], onDelete: Cascade)

  jobId String
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  notes   String?  @db.Text
  savedAt DateTime @default(now())

  @@id([seekerId, jobId])
}

// =================================================================
// WORK EXPERIENCE — Seeker's work history
// =================================================================

model WorkExperience {
  id String @id @default(cuid())

  seekerId String
  seeker   SeekerProfile @relation(fields: [seekerId], references: [id], onDelete: Cascade)

  companyName    String
  companyLogo    String?
  jobTitle       String
  employmentType EmploymentType
  workType       LocationType

  startDate DateTime
  endDate   DateTime?
  isCurrent Boolean   @default(false)

  description String?  @db.Text
  skills      String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =================================================================
// JOB NOTE — Community-contributed resources and tips
// =================================================================

model JobNote {
  id String @id @default(cuid())

  authorId String
  author   SeekerProfile @relation("JobNoteAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  category NoteCategory
  title    String
  content  String       @db.Text

  savedCount  Int     @default(0)
  isPublished Boolean @default(false)
  isFeatured  Boolean @default(false)

  saves JobNoteSave[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Join table for JobNote saves
model JobNoteSave {
  seekerId String
  seeker   SeekerProfile @relation(fields: [seekerId], references: [id], onDelete: Cascade)

  noteId String
  note   JobNote @relation(fields: [noteId], references: [id], onDelete: Cascade)

  savedAt DateTime @default(now())

  @@id([seekerId, noteId])
}

enum NoteCategory {
  BUILDING_PATHS // Career path discovery
  WRITE_YOUR_STORY // Resume & cover letter tips
  PREP_TALK // Interview preparation
  THE_SEARCH // Job search strategies
}

// =================================================================
// ONBOARDING ENUMS
// =================================================================

enum CareerStage {
  STUDENT // Currently in school
  ENTRY_LEVEL // Just starting career
  MID_CAREER // 3-7 years experience
  SENIOR // 7+ years experience
  CAREER_CHANGER // Transitioning from another field
  RETURNING // Returning to workforce
}

// =================================================================
// SEEKER PATHWAY — Many-to-many for pathway interests
// =================================================================

model SeekerPathway {
  seekerId String
  seeker   SeekerProfile @relation(fields: [seekerId], references: [id], onDelete: Cascade)

  pathwayId String
  pathway   Pathway @relation(fields: [pathwayId], references: [id], onDelete: Cascade)

  // How interested they are (for sorting/matching)
  priority Int      @default(0)
  addedAt  DateTime @default(now())

  @@id([seekerId, pathwayId])
}

// =================================================================
// SYNDICATION LOG — Tracks job postings to external platforms.
// =================================================================

model SyndicationLog {
  id String @id @default(cuid())

  jobId String
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  platform   String // "indeed", "linkedin", "ziprecruiter"
  action     String // "post", "update", "remove"
  status     String // "pending", "success", "failed"
  externalId String? // Platform's external job ID
  error      String?

  createdAt DateTime @default(now())

  @@index([jobId, platform])
}

// =================================================================
// AUDIT LOG — Tracks sensitive operations for compliance & debugging.
// Records payments, admin actions, status changes, and refunds.
// =================================================================

model AuditLog {
  id         String  @id @default(cuid())
  action     String // "CREATE" | "UPDATE" | "DELETE" | "REFUND" | "APPROVE" | "REJECT"
  entityType String // "Booking" | "CoachProfile" | "Application" | "Session"
  entityId   String
  userId     String? // Account ID of the actor (null for system/webhook actions)
  changes    String? @db.Text // JSON: { field: { from: oldValue, to: newValue } }
  metadata   String? @db.Text // JSON: extra context (IP, reason, webhook event, etc.)

  createdAt DateTime @default(now())

  @@index([entityType, entityId])
  @@index([userId, createdAt])
  @@index([createdAt])
}

// =================================================================
// OFFER LETTER — Tracks the full offer lifecycle from draft to signed.
// One offer per application. Created when employer drags to "Offer" stage.
// =================================================================

enum OfferStatus {
  DRAFT
  SENT
  VIEWED
  AWAITING_SIGNATURE
  SIGNED
  WITHDRAWN
}

enum SigningMethod {
  SIGNING_LINK // External tool like DocuSign, HelloSign
  DOCUMENT_UPLOAD // Employer uploads a signing document
  OFFLINE // Signing handled outside the platform
}

model OfferRecord {
  id String @id @default(cuid())

  applicationId String      @unique
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdById String // OrgMember who created the offer

  // Offer terms
  salary         Int? // Annual salary in cents
  salaryCurrency String   @default("USD")
  startDate      DateTime
  department     String?
  managerId      String? // Reporting manager (OrgMember ID)
  notes          String?  @db.Text // Personal message from employer

  // Branded letter
  letterContent String @db.Text // Rendered offer letter body (HTML/markdown)

  // Signing configuration
  signingMethod       SigningMethod
  signingLink         String? // URL to external signing tool
  signingDocumentUrl  String? // Uploaded document URL
  signingInstructions String?       @db.Text // Custom Next Steps footer text

  // Status progression
  status      OfferStatus @default(DRAFT)
  sentAt      DateTime?
  viewedAt    DateTime?
  signedAt    DateTime?
  withdrawnAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([status])
}

// =================================================================
// INTERVIEW — Scheduled interview for a candidate application.
// Created when recruiter schedules from the pipeline.
// =================================================================

model Interview {
  id String @id @default(cuid())

  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  interviewerId String
  interviewer   OrganizationMember @relation(fields: [interviewerId], references: [id], onDelete: Cascade)

  organizationId String

  scheduledAt DateTime
  duration    Int             @default(60) // minutes
  type        InterviewType   @default(VIDEO)
  location    String? // Physical address for ONSITE
  meetingLink String? // Video call URL
  status      InterviewStatus @default(SCHEDULED)
  notes       String?         @db.Text

  cancelledAt DateTime?
  completedAt DateTime?

  // Calendar sync (Nango)
  calendarEventId  String? // External calendar event ID
  calendarProvider String? // "google-calendar" | "outlook-calendar"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([applicationId])
  @@index([interviewerId])
  @@index([organizationId])
  @@index([scheduledAt])
  @@index([status])
  @@index([organizationId, scheduledAt])
}

enum InterviewType {
  PHONE
  VIDEO
  ONSITE
}

enum InterviewStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// =================================================================
// EMAIL TEMPLATE — Reusable email templates per organization.
// Used for candidate communication (rejection, interview invite, etc.)
// =================================================================

model EmailTemplate {
  id String @id @default(cuid())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  type      EmailTemplateType
  name      String
  subject   String
  content   String            @db.Text // HTML content with {{variable}} placeholders
  variables String[] // Available variable names
  isDefault Boolean           @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([organizationId, type])
}

enum EmailTemplateType {
  REJECTION
  INTERVIEW_INVITE
  STAGE_ADVANCE
  WELCOME
  CUSTOM
}

// =================================================================
// APPROVAL REQUEST — Lightweight approval chain for job publish / offer send.
// =================================================================

model ApprovalRequest {
  id String @id @default(cuid())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  requesterId String
  requester   OrganizationMember @relation("ApprovalRequester", fields: [requesterId], references: [id], onDelete: Cascade)

  approverId String
  approver   OrganizationMember @relation("ApprovalApprover", fields: [approverId], references: [id], onDelete: Cascade)

  type     ApprovalType
  entityId String // Job ID or OfferRecord ID
  status   ApprovalStatus @default(PENDING)
  reason   String?        @db.Text // Rejection reason or approval note

  respondedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, status])
  @@index([approverId, status])
  @@index([requesterId])
  @@index([createdAt])
}

enum ApprovalType {
  JOB_PUBLISH
  OFFER_SEND
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

// =================================================================
// INTEGRATION CONNECTION — Lightweight tracking of external OAuth
// connections managed by Nango. Nango stores actual tokens; this
// model caches connection status for UI display.
// =================================================================

model IntegrationConnection {
  id String @id @default(cuid())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Who initiated the connection
  connectedByMemberId String?

  provider          String // "google-calendar", "outlook-calendar", "linkedin", "indeed", "slack"
  nangoConnectionId String // Nango connection ID: "org_{orgId}" or "member_{memberId}"

  // Scope: org-level (slack, syndication) vs member-level (calendar)
  scope String @default("organization") // "organization" | "member"

  // Status cache (actual tokens live in Nango)
  status String @default("active") // "active" | "error" | "expired" | "disconnected"

  // Cached provider account info
  providerAccountEmail String?
  providerAccountName  String?

  // Provider-specific config (e.g., Slack channel selection)
  config Json?

  errorMessage String?
  lastSyncedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, provider, nangoConnectionId])
  @@index([organizationId])
  @@index([provider])
  @@index([status])
}
